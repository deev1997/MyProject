steps:
  - label: "Terraform Workflow"
    key: "terraform-workflow"
    command: |
      cd terraform/
      # Initialize Terraform
      echo "Running terraform init..."
      terraform init -input=false -no-color

      # Run Terraform plan
      echo "Running terraform plan..."
      terraform plan -input=false -no-color -out=tfplan

      # Block for manual approval
      echo "Please review the Terraform plan above. Do you want to apply these changes?"
      read -p "Apply changes? (yes/no): " apply_changes

      if [[ "$apply_changes" == "yes" ]]; then
        # Apply Terraform changes
        echo "Running terraform apply..."
        terraform apply -input=false -no-color tfplan
      else
        echo "Terraform apply was not approved. Exiting."
        exit 1
      fi

      # Refresh the Terraform state
      echo "Running terraform refresh..."
      terraform refresh -input=false -no-color

      # Generate the inventory file
      echo "Generating inventory..."
      ./generate_inventory.sh

      # Run the Ansible playbook
      echo "Running Ansible playbook..."
      cd ../ansible/
      ansible-playbook -i inventory.ini install_azure_cli.yml
